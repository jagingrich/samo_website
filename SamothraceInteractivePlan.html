<!DOCTYPE html>
<html>
<head>
    <title>AES Interactive Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

    <script src="https://rawgit.com/Turbo87/leaflet-sidebar/master/src/L.Control.Sidebar.js"></script>

    <script src="https://rawgit.com/brunob/leaflet.fullscreen/master/Control.FullScreen.js"></script>
    <link rel="stylesheet" href="https://rawgit.com/brunob/leaflet.fullscreen/master/Control.FullScreen.css" />

    <script src="https://cdn.jsdelivr.net/gh/jagingrich/samo_website/Data/mapCode/SamothraceInteractivePlan.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jagingrich/samo_website@latest/Data/mapCode/SamothraceInteractivePlan.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="dropdown-container" class="dropdown-container">
            <div id="dropdown" class="dropdown"></div>
        </div>
    </div>
    <div id="map">
        <div id="sidebar">
            <h1>American Excavations Samothrace</h1>
            <div id="sidebar-content">
                Interactive Map Plan
            </div>
        </div>
    </div>
    

    <script>// initialize the map

        //setting initial map variables
        var groups = [];
        var tileLayers = [];
        var attribution;
        var jsonLayers = [];
        var jsons = [];

        //setting description creation vars
        var url;
        var defaultWebID = '(0)Introduction';
        var webID = defaultWebID;
        var description;
        var dropdownCreated = false;
        var dropdownDefault = [];
        var remove = [];
        var replace = [];

        //pulling updated initialization vars
        updateInputs();

        //setting description image widths according to window size
        var width = 'width ="400px"';
        var w = window.innerWidth;

        //map state
        var state = 0;
        
        //creating map variable, layer control, initial tile layers
        var map = L.map('map', {
            center: [40.50065, 25.53026],
            zoom: 18,
            fullscreenControl: true,
            fullscreenControlOptions: {
                position: 'topleft'
            }
        });
        var layerControl = L.control.layers({}, null, { collapsed: false }).addTo(map);
        var layerGroups = addLayersToGroups(tileLayers, generateLayerGroups({ groups: groups }));

        //creating map bounds
        var mapbounds = L.latLngBounds(L.latLng(40.49952, 25.52879),
            L.latLng(40.50176, 25.53177));
        map.flyToBounds(mapbounds);

        //creating sidebar
        var sidebar = L.control.sidebar('sidebar', {
            position: 'right',
            closeButton: false
        });
        map.addControl(sidebar);

        //creating legend
        addLegend();

        //adding refresh button
        addRefresh();
        
        //setting the initial sidebar text on loading the map
        updateOutput(webID, url, { remove: remove, replace: replace });
        setTimeout(function () {
            sidebar.show();
        }, 500);
        
        //listening for width change
        updateWidth();
        ['resize', 'deviceorientation'].forEach(function (e) {
            window.addEventListener(e, updateWidth);
        })

        if (jsonLayers.length == 0) {
            addLayers(layerGroups);
        } else {
            var jsonInputs = [];
            jsonLayers.forEach((j) => jsonInputs.push(readData(j)));

            //loading JSON data
            $.when.apply(null, jsonInputs).done(function (response) {
                //loading each JSON layer
                $.each(arguments, function (i, row) {
                    var status = row[1], data = row[0];
                    if (status === 'success') {
                        jsons.push(data);
                    }
                });
                layerGroups = addLayersToGroups(jsons, layerGroups); //add to map
                addLayers(layerGroups);

                //full name for dropdown display
                jsons.forEach(function (j) {
                    j.features.forEach(function (f) {
                        f.properties.fullName = '(' + f.properties.Label + ') ' + f.properties.Name;
                    });
                });
                //add dropdown to map
                addDropdown([...dropdownDefault, ...dropdownOptions(uniqueFeatures(jsons, 'fullName', 'Label'), 'WebCode', 'fullName')]);
                setTimeout(function () {
                    state = 1;
                    dropdownCreated = true;
                    L.control.dropdown('dropdown').addTo(map);
                }, 250);

                //adjusting zoom on orientation change or screen resize
                ['resize', 'deviceorientation'].forEach(function (e) {
                    window.addEventListener(e, (event) => {
                        zoomToFeature(jsons, webID);
                    });
                });
            });
        }

    </script>
</body>
</html>
